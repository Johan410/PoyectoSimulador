<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulador de Gato Electroestático 5.3 - Mejorado (Doble Carga)</title>
<style>
body {
    font-family: "Comic Sans MS", cursive;
    background: linear-gradient(135deg, #4a00e0, #8e2de2);
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
}

#container {
    background: #fff;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 800px;
    text-align: center;
}

h1 { color: #4a00e0; margin-top: 0; }

#status { margin-bottom: 20px; }
#charge-bar-container {
    width: 100%; height: 30px;
    background: #eee; border-radius: 15px;
    overflow: hidden; border: 2px solid #ddd;
}
#charge-bar-inner {
    width: 0%; height: 100%;
    background: #00bfff;
    border-radius: 15px 0 0 15px;
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: bold; font-size: 14px;
}

#game-area {
    position: relative;
    width: 100%; height: 400px;
    border: 3px dotted #aaa; border-radius: 10px;
    margin-top: 20px;
    overflow: hidden;
    background-image: url("habitacion.jpg");
    background-size: cover;
    background-position: center;
}

.objeto-wrapper { position: absolute; object-fit: contain; }
.objeto-wrapper img { width: 100%; height: 100%; pointer-events: none; }

.draggable { cursor: grab; user-select: none; }
.draggable:active { cursor: grabbing; }

/* MEJORA: Rayo más realista */
.lightning-segment {
    position: absolute;
    background: linear-gradient(to right, #00ffff, #ffffff, #00ffff);
    height: 4px;
    transform-origin: left center;
    z-index: 100;
    box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
    animation: lightningFlash 0.3s ease-out;
}

@keyframes lightningFlash {
    0% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
}

.glow {
    filter: drop-shadow(0 0 10px #ffff00) drop-shadow(0 0 20px #ffaa00);
    animation: pulse 1s infinite alternate;
}
@keyframes pulse {
    from { filter: drop-shadow(0 0 10px #ffff00) drop-shadow(0 0 20px #ffaa00); }
    to { filter: drop-shadow(0 0 15px #ffff00) drop-shadow(0 0 30px #ffaa00); }
}

.charge-particle {
    position: absolute;
    width: 18px; height: 18px;
    border-radius: 50%;
    font-size: 14px; font-weight: bold;
    display: none;
    justify-content: center; align-items: center;
    color: white; pointer-events: none; z-index: 15; opacity: 0.8;
}
.minus { background: #007bff; border:1px solid #0056b3; }
.plus { background: #dc3545; border:1px solid #a71d2a; }

.big-spark {
    position: absolute; width: 15px; height: 15px;
    background: #00ffff; border:2px solid white;
    border-radius:50%; opacity:0; animation: bigSparkFade 0.7s ease; pointer-events:none; z-index:20;
}
@keyframes bigSparkFade {
    from { opacity:1; transform: scale(0.5); }
    to { opacity:0; transform: scale(2.5); }
}

/* Tamaños y posiciones de objetos */
#gatoA-wrapper { width:100px; height:80px; top:150px; left:100px; z-index:10; }
#manoAbierta-wrapper { width:50px; height:70px; top:50px; left:300px; z-index:5; }
#peluche-wrapper { width:60px; height:60px; top:180px; left:450px; z-index:5; }
#gatoB-wrapper { width:90px; height:70px; top:280px; left:250px; z-index:5; }
#cama-wrapper { width:200px; height:100px; bottom:20px; right:20px; z-index:4; }
</style>
</head>
<body>
<div id="container">
<h1>Simulador de Gato Electroestático 5.3 - Mejorado (Doble Carga)</h1>
<div id="status">
<strong>Nivel de Carga:</strong>
<div id="charge-bar-container"><div id="charge-bar-inner">0 Carga</div></div>
</div>

<div id="game-area">
    <div id="gatoA-wrapper" class="objeto-wrapper draggable"><img src="gatoA1.png" alt="Gato principal"></div>
    <div id="manoAbierta-wrapper" class="objeto-wrapper draggable discharge-target"><img src="manoabierta.png" alt="Mano humana"></div>
    <div id="peluche-wrapper" class="objeto-wrapper draggable charge-source"><img src="peluche.png" alt="Peluche"></div>
    <div id="gatoB-wrapper" class="objeto-wrapper draggable charge-source"><img src="gatoB.png" alt="Otro gato"></div>
    <div id="cama-wrapper" class="objeto-wrapper draggable charge-source"><img src="cama.png" alt="Cama"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
// --- ÚNICO CAMBIO AQUÍ ---
const MAX_CHARGE=500; // Se duplicó de 100 a 200
// -------------------------

let chargeLevel=0,isDragging=false,isCharging=false,activeDraggable=null,lastMousePos={x:0,y:0};

const cat=document.getElementById('gatoA-wrapper');
const hand=document.getElementById('manoAbierta-wrapper');
const gameArea=document.getElementById('game-area');
const chargeBar=document.getElementById('charge-bar-inner');

const draggables=document.querySelectorAll('.draggable');
const chargeSources=document.querySelectorAll('.charge-source');
const dischargeTargets=document.querySelectorAll('.discharge-target');
const chargeSourceParticles=new Map();

function createParticlesForCat(){for(let i=0;i<MAX_CHARGE;i++)createChargeParticle('-',cat);}
function createChargeParticle(type,wrapper){
    const particle=document.createElement('div');
    particle.className='charge-particle '+(type==='+'?'plus':'minus');
    particle.textContent=type;
    particle.style.left=`${Math.random()*80+10}%`;
    particle.style.top=`${Math.random()*80+10}%`;
    wrapper.appendChild(particle);
    return particle;
}

function initParticles(){
    chargeSources.forEach(source=>{
        chargeSourceParticles.set(source,[]);
        for(let i=0;i<MAX_CHARGE;i++){
            const p=createChargeParticle('+',source);
            chargeSourceParticles.get(source).push(p);
        }
    });
    createParticlesForCat();
}

function updateChargeBar(){
    const p=(chargeLevel/MAX_CHARGE)*100;
    chargeBar.style.width=p+'%';
    chargeBar.textContent=`${Math.round(chargeLevel)} Carga`;
    chargeBar.style.backgroundColor=`hsl(${200-p*2},100%,50%)`;
    if(p>70)cat.classList.add('glow');else cat.classList.remove('glow');
}

function updateParticleVisibility(wrapper,amount,isPositive=false){
    let particles=isPositive?chargeSourceParticles.get(wrapper):wrapper.querySelectorAll('.minus');
    if(!particles)return;
    for(let i=0;i<particles.length;i++)particles[i].style.display=(i<Math.floor(amount)?'flex':'none');
}

function increaseCharge(amount,source){
    if(chargeLevel<MAX_CHARGE){
        chargeLevel=Math.min(MAX_CHARGE,chargeLevel+amount);
        updateParticleVisibility(cat,chargeLevel);
        updateParticleVisibility(source,chargeLevel,true);
        updateChargeBar();
    }
}

function discharge(){
    chargeLevel=0;
    updateChargeBar();
    updateParticleVisibility(cat,0);
    chargeSources.forEach(source=>updateParticleVisibility(source,0,true));
}

function getDistance(el1,el2){
    const r1=el1.getBoundingClientRect(),r2=el2.getBoundingClientRect();
    const c1={x:r1.left+r1.width/2,y:r1.top+r1.height/2};
    const c2={x:r2.left+r2.width/2,y:r2.top+r2.height/2};
    const dx=c1.x-c2.x,dy=c1.y-c2.y;
    return Math.sqrt(dx*dx+dy*dy);
}

// MEJORA: Función para crear un rayo más realista con múltiples segmentos
function createLightningBolt(startX, startY, endX, endY, segments = 10) {
    // Calcular la distancia total y el ángulo
    const dx = endX - startX;
    const dy = endY - startY;
    const distance = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx);
    
    // Crear segmentos del rayo
    const segmentLength = distance / segments;
    let lastX = startX;
    let lastY = startY;
    
    for (let i = 1; i <= segments; i++) {
        const segmentEndX = startX + (dx * i) / segments;
        const segmentEndY = startY + (dy * i) / segments;
        
        // Añadir variación aleatoria para hacer el rayo más natural
        const variation = (i < segments) ? 15 : 0; // No variar el último segmento
        const midX = (lastX + segmentEndX) / 2 + (Math.random() - 0.5) * variation;
        const midY = (lastY + segmentEndY) / 2 + (Math.random() - 0.5) * variation;
        
        // Crear segmento curvo
        createLightningSegment(lastX, lastY, midX, midY, segmentEndX, segmentEndY);
        
        lastX = segmentEndX;
        lastY = segmentEndY;
    }
}

// MEJORA: Función para crear un segmento curvo del rayo
function createLightningSegment(x1, y1, x2, y2, x3, y3) {
    const segment = document.createElement('div');
    segment.className = 'lightning-segment';
    
    // Calcular longitud y ángulo del segmento
    const dx = x3 - x1;
    const dy = y3 - y1;
    const length = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
    
    // Posicionar y rotar el segmento
    segment.style.left = x1 + 'px';
    segment.style.top = y1 + 'px';
    segment.style.width = length + 'px';
    segment.style.transform = `rotate(${angle}deg)`;
    
    // Añadir al área de juego
    gameArea.appendChild(segment);
    
    // Eliminar después de la animación
    setTimeout(() => {
        if (segment.parentNode) {
            segment.parentNode.removeChild(segment);
        }
    }, 300);
}

function createBigSpark(element){
    for(let i=0;i<10;i++){
        const spark=document.createElement('div');
        spark.className='big-spark';
        gameArea.appendChild(spark);
        const rect=element.getBoundingClientRect();
        const gRect=gameArea.getBoundingClientRect();
        const x=rect.left-gRect.left+rect.width/2;
        const y=rect.top-gRect.top+rect.height/2;
        const angle=Math.random()*Math.PI*2;
        const distance=Math.random()*50+30;
        spark.style.left=x+'px';
        spark.style.top=y+'px';
        spark.offsetWidth;
        spark.style.transform=`translate(${Math.cos(angle)*distance}px,${Math.sin(angle)*distance}px) scale(1)`;
        spark.style.opacity='0';
        setTimeout(()=>spark.remove(),700);
    }
}

// MEJORA: Función para dibujar el rayo mejorado
function drawImprovedLightning(el1, el2) {
    const r1 = el1.getBoundingClientRect();
    const r2 = el2.getBoundingClientRect();
    const g = gameArea.getBoundingClientRect();
    
    const startX = r1.left - g.left + r1.width / 2;
    const startY = r1.top - g.top + r1.height / 2;
    const endX = r2.left - g.left + r2.width / 2;
    const endY = r2.top - g.top + r2.height / 2;
    
    // Crear múltiples rayos para un efecto más impactante
    for (let i = 0; i < 3; i++) {
        setTimeout(() => {
            createLightningBolt(startX, startY, endX, endY, 8 + Math.floor(Math.random() * 5));
        }, i * 50);
    }
}

function checkSparkJump(){
    if(chargeLevel<10)return;
    const d=getDistance(cat,hand);
    if(d<chargeLevel*1.5){
        drawImprovedLightning(cat,hand);
        createBigSpark(hand);
        discharge();
    }
}

function onDragStart(e){
    if(e.target.tagName==='IMG') e.preventDefault();
    activeDraggable=this;
    this.style.cursor='grabbing';
    this.style.zIndex=1000;
    const rect=this.getBoundingClientRect();
    this.offsetX=e.clientX-rect.left;
    this.offsetY=e.clientY-rect.top;
    if(this.id==='gatoA-wrapper'){isCharging=true;lastMousePos={x:e.clientX,y:e.clientY};}
    isDragging=true;
}

function onDragMove(e){
    if(!isDragging||!activeDraggable)return;
    const gR=gameArea.getBoundingClientRect();
    let x=e.clientX-gR.left-activeDraggable.offsetX;
    let y=e.clientY-gR.top-activeDraggable.offsetY;
    x=Math.max(0,Math.min(x,gR.width-activeDraggable.offsetWidth));
    y=Math.max(0,Math.min(y,gR.height-activeDraggable.offsetHeight));
    activeDraggable.style.left=x+'px';
    activeDraggable.style.top=y+'px';
    if(activeDraggable.id==='gatoA-wrapper'){
        const dx=e.clientX-lastMousePos.x,dy=e.clientY-lastMousePos.y,d=Math.sqrt(dx*dx+dy*dy);
        if(isCharging && d>5){for(const s of chargeSources){
            const catRect=cat.getBoundingClientRect(),sRect=s.getBoundingClientRect();
            if(catRect.left<sRect.right && catRect.right>sRect.left && catRect.top<sRect.bottom && catRect.bottom>sRect.top){increaseCharge(d*0.05,s); break;}
        }}
        checkSparkJump();
        lastMousePos={x:e.clientX,y:e.clientY};
    }
}

function onDragEnd(){if(activeDraggable){activeDraggable.style.cursor='grab';activeDraggable.style.zIndex=(activeDraggable.id==='gatoA-wrapper'?10:5);}isDragging=false;isCharging=false;activeDraggable=null;}

draggables.forEach(el=>el.addEventListener('mousedown',onDragStart));
document.addEventListener('mousemove',onDragMove);
document.addEventListener('mouseup',onDragEnd);

initParticles();
});
</script>
</body>
</html>